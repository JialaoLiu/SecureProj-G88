<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin: 10px 0; }
        button { margin: 5px; padding: 5px 10px; }
        textarea { width: 100%; height: 80px; }
    </style>
</head>
<body>
    <h3>SOCP WebSocket Test</h3>
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
    <button onclick="sendHeartbeat()">Send Heartbeat</button>
    <button onclick="sendInvalid()">Send Invalid</button>
    <button onclick="testRateLimit()">Test Rate Limit</button>

    <div id="messages"></div>

    <textarea id="customMsg" placeholder="Custom JSON message..."></textarea>
    <button onclick="sendCustom()">Send Custom</button>

    <script>
        let ws = null;
        const messages = document.getElementById('messages');

        function log(msg) {
            messages.innerHTML += new Date().toLocaleTimeString() + ': ' + msg + '<br>';
            messages.scrollTop = messages.scrollHeight;
        }

        function connect() {
            if (ws) return;
            ws = new WebSocket('ws://localhost:8080');

            ws.onopen = () => log('✅ Connected');
            ws.onclose = () => { log('❌ Disconnected'); ws = null; };
            ws.onerror = (e) => log('💥 Error: ' + e);
            ws.onmessage = (e) => log('📩 Received: ' + e.data);
        }

        function disconnect() {
            if (ws) { ws.close(); ws = null; }
        }

        function sendHeartbeat() {
            if (!ws) return log('Not connected');
            const msg = {
                type: "HEARTBEAT",
                from: "html-test",
                to: "server",
                ts: Date.now(),
                payload: {},
                sig: "test-sig"
            };
            ws.send(JSON.stringify(msg));
            log('📤 Sent: HEARTBEAT');
        }

        function sendInvalid() {
            if (!ws) return log('Not connected');
            ws.send("invalid json");
            log('📤 Sent: invalid json');
        }

        function testRateLimit() {
            if (!ws) return log('Not connected');
            for (let i = 0; i < 15; i++) {
                setTimeout(() => sendHeartbeat(), i * 50);
            }
            log('📤 Sent: 15 rapid messages (testing rate limit)');
        }

        function sendCustom() {
            if (!ws) return log('Not connected');
            const custom = document.getElementById('customMsg').value;
            if (!custom) return;
            ws.send(custom);
            log('📤 Sent: ' + custom);
        }
    </script>
</body>
</html>